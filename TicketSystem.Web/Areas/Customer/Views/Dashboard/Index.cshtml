@model TicketSystem.Application.Features.Dashboard.Queries.GetDashboardStats.DashboardStatsDto
@{
    ViewData["Title"] = "Dashboard";
    var recentTickets = ViewBag.RecentTickets as List<TicketSystem.Application.Features.Tickets.DTOs.TicketListDto>;
    var recentActivities = ViewBag.RecentActivities as List<TicketSystem.Web.Areas.Customer.Controllers.RecentActivityDto> ?? new List<TicketSystem.Web.Areas.Customer.Controllers.RecentActivityDto>();
    var customerName = ViewBag.CustomerName as string ?? "Bilinmeyen Müşteri";
}

<!-- Header Welcome Section -->
<div class="relative bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-800 rounded-3xl text-white p-8 mb-8 overflow-hidden">
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-10">
        <svg class="w-full h-full" fill="currentColor" viewBox="0 0 400 400">
            <defs>
                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                    <circle cx="20" cy="20" r="1" />
                </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#grid)" />
        </svg>
    </div>

    <div class="relative flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold mb-2">Hoş Geldiniz!</h1>
            <p class="text-blue-100 text-lg">
                @(User.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value ?? "")
                @(User.FindFirst(System.Security.Claims.ClaimTypes.Surname)?.Value ?? "")
            </p>
            <p class="text-blue-200 text-sm mt-2">
                <i class="fas fa-building mr-1"></i>
                @customerName
            </p>
        </div>
        <div class="text-right">
            <div class="bg-white/20 rounded-2xl p-4 backdrop-blur-sm">
                <p class="text-blue-100 text-sm">Bugün</p>
                <p class="text-2xl font-bold">@DateTime.Now.ToString("dd")</p>
                <p class="text-sm">@DateTime.Now.ToString("MMMM yyyy")</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Overview - 5 Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
    <!-- Total Tickets -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-300 group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Toplam</p>
                <p class="text-3xl font-bold text-gray-900">@Model.TotalTickets</p>
                <div class="flex items-center mt-2">
                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-500">Tüm ticket'lar</span>
                </div>
            </div>
            <div class="w-14 h-14 bg-gray-100 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-ticket-alt text-gray-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Under Review Tickets -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-300 group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">İnceleniyor</p>
                <p class="text-3xl font-bold text-yellow-600">@Model.TicketsByStatus.FirstOrDefault(x => x.Status == "İnceleniyor")?.Count ?? 0</p>
                <div class="flex items-center mt-2">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-500">Bekleyen</span>
                </div>
            </div>
            <div class="w-14 h-14 bg-yellow-100 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-eye text-yellow-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- In Progress Tickets -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-300 group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">İşlemde</p>
                <p class="text-3xl font-bold text-blue-600">@Model.TicketsByStatus.FirstOrDefault(x => x.Status == "İşlemde")?.Count 0</p>
                <div class="flex items-center mt-2">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-500">Çalışılıyor</span>
                </div>
            </div>
            <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-cog text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Resolved Tickets -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-300 group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Çözüldü</p>
                <p class="text-3xl font-bold text-green-600">@Model.ResolvedTickets</p>
                <div class="flex items-center mt-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-500">Tamamlandı</span>
                </div>
            </div>
            <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-check-circle text-green-600 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Closed Tickets -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-300 group">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Kapandı</p>
                <p class="text-3xl font-bold text-gray-600">@Model.ClosedTickets</p>
                <div class="flex items-center mt-2">
                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                    <span class="text-xs text-gray-500">Kapatıldı</span>
                </div>
            </div>
            <div class="w-14 h-14 bg-gray-100 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-times-circle text-gray-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Ticket Types Chart -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-chart-pie mr-2 text-indigo-600"></i>
            Ticket Türlerine Göre Dağılım
        </h3>
        @if (Model.TicketsByType.Any())
        {
            <div class="space-y-4">
                @foreach (var type in Model.TicketsByType)
                {
                    var percentage = Model.TotalTickets > 0 ? Math.Round((double)type.Count / Model.TotalTickets * 100, 1) : 0;
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3" style="background-color: @type.Color"></div>
                            <span class="text-sm font-medium text-gray-700">@type.TypeName</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm font-bold text-gray-900 mr-2">@type.Count</span>
                            <span class="text-xs text-gray-500">(@percentage%)</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div class="h-2 rounded-full transition-all duration-500"
                             style="width: @percentage%; background-color: @type.Color"></div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-8">
                <i class="fas fa-chart-pie text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500">Henüz veri bulunmuyor</p>
            </div>
        }
    </div>

    <!-- Ticket Categories Chart -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-tags mr-2 text-green-600"></i>
            Kategorilere Göre Dağılım
        </h3>
        @if (Model.TicketsByCategory.Any())
        {
            <div class="space-y-4">
                @foreach (var category in Model.TicketsByCategory)
                {
                    var percentage = Model.TotalTickets > 0 ? Math.Round((double)category.Count / Model.TotalTickets * 100, 1) : 0;
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3" style="background-color: @category.Color"></div>
                            <span class="text-sm font-medium text-gray-700">@category.CategoryName</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm font-bold text-gray-900 mr-2">@category.Count</span>
                            <span class="text-xs text-gray-500">(@percentage%)</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div class="h-2 rounded-full transition-all duration-500"
                             style="width: @percentage%; background-color: @category.Color"></div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-8">
                <i class="fas fa-tags text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500">Henüz veri bulunmuyor</p>
            </div>
        }
    </div>
</div>

<!-- Recent Activity & Tickets -->
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
    <!-- Recent Tickets -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-history mr-3 text-blue-600"></i>
                    Son Ticket'lar
                </h3>
                <a href="@Url.Action("Index", "Tickets")"
                   class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">
                    Tümünü Gör
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
        </div>

        <div class="p-6">
            @if (recentTickets?.Any() == true)
            {
                <div class="space-y-4">
                    @foreach (var ticket in recentTickets.Take(5))
                    {
                        <div class="flex items-start justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors group">
                            <div class="flex items-start flex-1">
                                <div class="w-3 h-3 rounded-full mr-3 mt-2" style="background-color: @ticket.TypeColor"></div>
                                <div class="flex-1">
                                    <div class="flex items-center mb-1">
                                        <span class="text-sm font-semibold text-gray-900 mr-2">#@ticket.TicketNumber</span>
                                        <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full
                                                            @(ticket.StatusDisplay == "İnceleniyor" ? "bg-yellow-100 text-yellow-800" :
                                                                                                    ticket.StatusDisplay == "İşlemde" ? "bg-blue-100 text-blue-800" :
                                                                                                    ticket.StatusDisplay == "Çözüldü" ? "bg-green-100 text-green-800" :
                                                                                                    "bg-gray-100 text-gray-800")">
                                    @ticket.StatusDisplay
                                </span>
                            </div>
                            <h4 class="text-sm font-medium text-gray-900 mb-1 line-clamp-2">@ticket.Title</h4>
                            <div class="flex items-center text-xs text-gray-500">
                                <span>@ticket.TypeName</span>
                                <span class="mx-2">•</span>
                                <span>@ticket.CreatedAt.ToString("dd.MM.yyyy")</span>
                            </div>
                        </div>
                    </div>
                    <a href="@Url.Action("Details", "Tickets", new { id = ticket.Id })"
                       class="ml-4 p-2 text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-all duration-200">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                                }
                </div>
            }
            else
            {
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-ticket-alt text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Henüz Ticket Yok</h3>
                    <p class="text-gray-600 mb-4">İlk destek talebinizi oluşturun</p>
                    <a href="@Url.Action("Create", "Tickets")"
                       class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium">
                        <i class="fas fa-plus mr-2"></i>
                        Yeni Ticket Oluştur
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- Activity Timeline -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-timeline mr-3 text-green-600"></i>
                Son Aktiviteler
            </h3>
        </div>

        <div class="p-6">
            @if (recentActivities.Any())
            {
                <div class="space-y-6">
                    @foreach (var activity in recentActivities.Take(8))
                    {
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-2 h-2 @activity.Color rounded-full mt-3 mr-4"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">@activity.Title</p>
                                <p class="text-xs text-gray-500">@activity.Description</p>
                                <p class="text-xs text-gray-400 mt-1">@GetTimeAgo(activity.CreatedAt)</p>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clock text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Henüz Aktivite Yok</h3>
                    <p class="text-gray-600">Ticket işlemleri burada görünecek</p>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add entrance animations
            const cards = document.querySelectorAll('.grid > div');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Counter animation for stats
            const counters = document.querySelectorAll('.text-3xl.font-bold');
            counters.forEach(counter => {
                const target = parseInt(counter.textContent);
                if (!isNaN(target)) {
                    let current = 0;
                    const increment = target / 20;
                    const timer = setInterval(() => {
                        current += increment;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        counter.textContent = Math.floor(current);
                    }, 50);
                }
            });

            // Auto-refresh dashboard data every 5 minutes
            setInterval(() => {
                // Could implement AJAX refresh here
                console.log('Dashboard refresh interval');
            }, 300000); // 5 minutes
        });
    </script>
}

@functions {
    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.Days > 0)
            return $"{timeSpan.Days} gün önce";
        if (timeSpan.Hours > 0)
            return $"{timeSpan.Hours} saat önce";
        if (timeSpan.Minutes > 0)
            return $"{timeSpan.Minutes} dakika önce";

        return "Az önce";
    }
}