@model TicketSystem.Application.Features.Tickets.DTOs.TicketDto
@{
    ViewData["Title"] = $"#{Model.TicketNumber}";
}

<!-- Header -->
<div class="bg-white border-b border-gray-200 mb-6">
    <div class="px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="@Url.Action("Index")" class="inline-flex items-center px-3 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Geri
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">@Model.Title</h1>
                    @* <p class="text-sm text-gray-500 mt-1">@Model.CreatedAt.ToString("dd MMMM yyyy, HH:mm") • @Model.CreatedBy.FullName</p> *@
                </div>
            </div>

            <div class="flex items-center space-x-3">
                <!-- Status Badge -->
                <span class="inline-flex items-center px-3 py-1 text-sm font-semibold rounded-full
                    @(Model.StatusDisplay == "İnceleniyor" ? "bg-yellow-100 text-yellow-800" :
                                            Model.StatusDisplay == "İşlemde" ? "bg-blue-100 text-blue-800" :
                                            Model.StatusDisplay == "Çözüldü" ? "bg-green-100 text-green-800" :
                                            "bg-gray-100 text-gray-800")">
                    @switch (Model.StatusDisplay)
                    {
                        case "İnceleniyor":
                            <i class="fas fa-clock mr-1"></i>
                            break;
                        case "İşlemde":

                            <i class="fas fa-cog mr-1"></i>
                            break;
                        case "Çözüldü":

                            <i class="fas fa-check mr-1"></i>
                            break;
                        default:

                            <i class="fas fa-times mr-1"></i>
                            break;
                    }
                    @Model.StatusDisplay
                </span>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- Main Content -->
    <div class="lg:col-span-3 space-y-6">

        <!-- Ticket Details -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            @* <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-lg font-bold text-gray-900">@Model.Title</h2>
                <div class="flex items-center space-x-4 text-sm text-gray-600 mt-2">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-2" style="background-color: @Model.Type.Color"></div>
                        <span>@Model.Type.Name</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-2" style="background-color: @Model.Category.Color"></div>
                        <span>@Model.Category.Name</span>
                    </div>
                    <span>@Model.Customer.Name</span>
                </div>
            </div> *@

            <div class="p-6 space-y-6">
                <!-- Description -->
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <div>
                        <h3 class="text-sm font-semibold text-gray-900 mb-3">Açıklama</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-sm text-gray-800 whitespace-pre-wrap">@Model.Description</p>
                        </div>
                    </div>
                }

                <!-- Form Data -->
                @if (Model.FormData != null && Model.FormData.Any())
                {
                    <div>
                        <h3 class="text-sm font-semibold text-gray-900 mb-3">Bilgiler</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                            @* @if (!string.IsNullOrEmpty(Model.SelectedModule))
                            {
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-900 mb-2">Seçilen Modül</h3>
                                    <span class="inline-flex items-center px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">
                                        <i class="fas fa-puzzle-piece mr-2"></i>@Model.SelectedModule
                                    </span>
                                </div>
                            } *@

                            @foreach (var field in Model.FormData)
                            {
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <dt class="text-xs font-medium text-gray-600 mb-1">@field.Key</dt>
                                    <dd class="text-sm font-medium text-gray-900">
                                        @if (field.Value?.ToString()?.ToLower() == "true")
                                        {
                                            <span class="inline-flex items-center px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">
                                                <i class="fas fa-check mr-1"></i>Evet
                                            </span>
                                        }
                                        else if (field.Value?.ToString()?.ToLower() == "false")
                                        {
                                            <span class="inline-flex items-center px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">
                                                <i class="fas fa-times mr-1"></i>Hayır
                                            </span>
                                        }
                                        else
                                        {
                                            @(field.Value ?? "Belirtilmemiş")
                                        }
                                    </dd>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Comments Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900">
                    Yorumlar (@Model.Comments.Count)
                </h3>
            </div>

            <div class="p-6">
                <!-- Add Comment Form -->
                <form method="post" action="/Admin/Tickets/AddComment" class="mb-6">
                    <input type="hidden" name="ticketId" value="@Model.Id" />

                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="mb-4">
                            <textarea name="content" rows="3" required
                                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                                      placeholder="Yorumunuzu yazın..."></textarea>
                        </div>

                        <div class="flex items-center justify-between">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" name="isInternal" value="true" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2">
                                <span class="text-gray-700">İç not (sadece adminler görebilir)</span>
                            </label>

                            <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-paper-plane mr-2"></i>Yorum Ekle
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Comments List -->
                <!-- Comments List -->
                @{
                    var publicComments = Model.Comments.OrderByDescending(c => c.CreatedAt);
                }

                @if (publicComments.Any())
                {
                    <div class="space-y-4">
                        @foreach (var comment in publicComments)
                        {
                            var commentUser = comment.User.Role == "Admin" ? "Admin" : "Müşteri";

                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start justify-between">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-white font-medium text-sm">
                                            @comment.User.FullName.Substring(0, 1).ToUpper()
                                        </span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <div>
                                                <h4 class="text-sm font-semibold text-gray-900">@comment.User.FullName</h4>
                                                <p class="text-xs text-gray-500">@comment.CreatedAt.ToString("dd MMMM yyyy, HH:mm")</p>
                                                @if (@comment.IsInternal == true)
                                                {
                                                    <span class="inline-flex items-center px-2 py-0.5 text-xs bg-red-100 text-red-800 rounded">Gizli Mesaj(Sadece Adminler)</span>

                                                }
                                            </div>
                                            <span class="inline-flex items-center px-2 py-0.5 text-xs bg-blue-100 text-blue-800 rounded">
                                                <i class="fas fa-user mr-1"></i> @commentUser
                                            </span>
                                            
                                        </div>
                                        <div class="text-sm text-gray-800 whitespace-pre-wrap">@comment.Content</div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-8">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-comment-slash text-gray-400"></i>
                        </div>
                        <h3 class="text-sm font-semibold text-gray-900 mb-1">Henüz Yorum Yok</h3>
                        <p class="text-xs text-gray-600">Bu ticket için henüz hiç yorum yapılmamış.</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">

        <!-- Status Actions -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Durum İşlemleri</h3>
            </div>

            <div class="p-4 space-y-3">
                @if (Model.Status == TicketSystem.Domain.Enums.TicketStatus.İnceleniyor)
                {
                    <!-- Onay Formu -->
                    <form method="post" action="/Admin/Tickets/UpdateStatus" class="space-y-3">
                        <input type="hidden" name="ticketId" value="@Model.Id" />
                        <input type="hidden" name="newStatus" value="İşlemde" />

                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Onay Notu</label>
                            <textarea name="comment" rows="2"
                                  class="w-full px-3 py-2 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Onay notu (isteğe bağlı)"></textarea>
                        </div>

                        @* <div class="flex items-center">
                            <input type="checkbox" name="sendToPmo" value="true" id="sendToPmo"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="sendToPmo" class="ml-2 text-xs text-gray-700">PMO'ya gönder</label>
                        </div> *@

                        <button type="submit" class="w-full bg-green-600 text-white px-3 py-2 text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-check mr-2"></i>Onayla
                        </button>
                    </form>

                    <!-- Reddet -->
                    <form method="post" action="/Admin/Tickets/UpdateStatus">
                        <input type="hidden" name="ticketId" value="@Model.Id" />
                        <input type="hidden" name="newStatus" value="Reddedildi" />
                        <button type="submit" class="w-full bg-red-600 text-white px-3 py-2 text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-times mr-2"></i>Reddet
                        </button>
                    </form>
                }
                else if (Model.Status == TicketSystem.Domain.Enums.TicketStatus.İşlemde)
                {
                    <!-- Çözüldü İşaretle -->
                    <form method="post" action="/Admin/Tickets/UpdateStatus">
                        <input type="hidden" name="ticketId" value="@Model.Id" />
                        <input type="hidden" name="newStatus" value="Çözüldü" />

                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Çözüm Notu</label>
                            <textarea name="comment" rows="2"
                                  class="w-full px-3 py-2 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Çözüm açıklaması"></textarea>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white px-3 py-2 text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-check-circle mr-2"></i>Çözüldü Olarak İşaretle
                        </button>
                    </form>
                }
                else if (Model.Status == TicketSystem.Domain.Enums.TicketStatus.Çözüldü)
                {
                    <!-- Kapat -->
                    <form method="post" action="/Admin/Tickets/UpdateStatus">
                        <input type="hidden" name="ticketId" value="@Model.Id" />
                        <input type="hidden" name="newStatus" value="Kapandı" />
                        <button type="submit" class="w-full bg-gray-600 text-white px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-archive mr-2"></i>Ticket'ı Kapat
                        </button>
                    </form>
                }
                else
                {
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-check-circle text-2xl mb-2"></i>
                        <p class="text-xs">Bu ticket işlem tamamlandı</p>
                    </div>
                }
            </div>
        </div>

        <!-- Ticket Info -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-900">Ticket Bilgileri</h3>
            </div>

            <div class="p-4 space-y-3 text-xs">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Tür</span>
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full mr-2" style="background-color: @Model.Type.Color"></div>
                        <span class="font-medium text-gray-900">@Model.Type.Name</span>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Kategori</span>
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full mr-2" style="background-color: @Model.Category.Color"></div>
                        <span class="font-medium text-gray-900">@Model.Category.Name</span>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Modül/Ekran</span>
                    <div class="flex items-center">
                        <span class="font-medium text-gray-900">@Model.SelectedModule</span>
                    </div>
                </div>

                

                @if (Model.AssignedTo != null)
                {
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Atanan</span>
                        <span class="font-medium text-gray-900">@Model.AssignedTo.FullName</span>
                    </div>
                }

                <div class="border-t border-gray-200 pt-3">
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Müşteri</span>
                            <span class="font-medium text-gray-900">@Model.Customer.Name</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Oluşturan</span>
                            <span class="font-medium text-gray-900">@Model.CreatedBy.FullName</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Oluşturulma</span>
                            <span class="font-medium text-gray-900">@Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Son Güncelleme</span>
                            <span class="font-medium text-gray-900">@Model.UpdatedAt.ToString("dd.MM.yyyy HH:mm")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attachments -->
        @if (Model.Attachments.Any())
        {
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-sm font-semibold text-gray-900">Dosyalar (@Model.Attachments.Count)</h3>
                </div>

                <div class="p-4">
                    <div class="space-y-2">
                        @foreach (var attachment in Model.Attachments)
                        {
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-file text-gray-400 mr-2"></i>
                                    <span class="text-xs text-gray-900 truncate">@attachment.FileName</span>
                                </div>
                                <span class="text-xs text-gray-500">@((attachment.FileSize / 1024).ToString("N0")) KB</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        
        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h4 class="text-sm font-semibold text-gray-900">Hızlı İşlemler</h4>
            </div>
            <div class="p-4 space-y-2">
                <a href="@Url.Action("Index")"
                   class="flex items-center w-full px-3 py-2 text-xs text-gray-700 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-list mr-2"></i>Tüm Ticket'lar
                </a>
                <button onclick="window.print()"
                        class="flex items-center w-full px-3 py-2 text-xs text-gray-700 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-print mr-2"></i>Yazdır
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form submit handling
            const forms = document.querySelectorAll('form[method="post"]');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        const originalContent = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>İşleniyor...';

                        // Timeout protection
                        setTimeout(() => {
                            if (submitBtn.disabled) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalContent;
                            }
                        }, 10000);
                    }
                });
            });
        });
    </script>

    <style>
        @@media print {
            .no-print

        {
            display: none !important;
        }

        body {
            font-size: 11pt;
        }

        .bg-gradient-to-r {
            background: #f8f9fa !important;
        }

        }
    </style>
}